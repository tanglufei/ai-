<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ¨¡å‹AIèŠå¤©åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§ä¼šè¯åˆ—è¡¨ */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: #f8f9fa;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-header h1 {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px;
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #f5f5f5;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 15px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 5px 8px;
            background: white;
        }

        .conversation-item:hover {
            background: #f8f9fa;
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .conversation-item.active {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conversation-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }

        .conversation-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .conversation-actions button:hover {
            background: rgba(0,0,0,0.1);
        }

        .edit-btn:hover {
            background: rgba(0, 123, 255, 0.1) !important;
        }

        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.1) !important;
        }

        .message-edit-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message.user {
            position: relative;
        }

        .message.user:hover .message-edit-btn {
            opacity: 1;
        }

        .message-edit-btn:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        .conversation-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-preview {
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .load-more {
            padding: 10px;
            text-align: center;
            color: #666;
            cursor: pointer;
            font-size: 14px;
        }

        .load-more:hover {
            background: #f8f9fa;
        }

        /* å³ä¾§èŠå¤©åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .model-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .provider-selector, .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .provider-selector select, .model-selector select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            width: 200px;
        }

        .api-key-input {
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .api-key-input label, .context-settings label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
        }

        .api-key-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .api-key-input input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .context-settings > div {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .context-settings input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }

        .context-settings button {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .context-settings button:hover {
            background: #0056b3;
        }

        .role-settings {
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .role-settings > div {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .role-settings select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 120px;
        }

        .role-settings button {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .role-settings button:hover {
            background: #218838;
        }

        .role-item {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .role-item strong {
            color: #495057;
            display: block;
            margin-bottom: 5px;
        }

        .role-item p {
            color: #6c757d;
            font-size: 13px;
            margin: 0;
        }

        .custom-role-section {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .search-enhanced {
            border-left: 3px solid #2196F3 !important;
        }

        .search-enhanced .message-content {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%) !important;
        }

        .search-settings {
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .search-settings > div {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .search-indicator {
            display: inline-block;
            color: #2196F3;
            font-size: 12px;
            margin-left: 5px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #333;
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message.system .message-content {
            background: #f5f5f5;
            color: #666;
            font-style: italic;
            text-align: center;
            max-width: 100%;
        }

        .message-info {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #666;
        }

        .send-button {
            padding: 10px 20px;
            background: #333;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s;
        }

        .send-button:hover {
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 20px;
            border: 1px solid #ffcdd2;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .model-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-end;
            }
            
            .api-key-input input {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å·¦ä¾§ä¼šè¯åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>AIèŠå¤©åŠ©æ‰‹</h1>
                <button class="new-chat-btn" id="new-chat-btn">+ æ–°å»ºå¯¹è¯</button>
            </div>
            <div class="conversations-list" id="conversations-list">
                <!-- ä¼šè¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="load-more" id="load-more" style="display: none;">åŠ è½½æ›´å¤šä¼šè¯...</div>
        </div>

        <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title" id="chat-title">é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªå¯¹è¯</div>
                <div class="model-controls">
                    <div class="provider-selector">
                        <label>æä¾›å•†:</label>
                        <select id="provider-select">
                            <option value="openrouter">OpenRouter (ç»Ÿä¸€æ¥å£)</option>
                        </select>
                    </div>
                    <div class="model-selector">
                        <label>æ¨¡å‹:</label>
                        <select id="model-select">
                            <optgroup label="ğŸ¤– é¡¶çº§æ¨¡å‹">
                                <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                                <option value="openai/gpt-4o">GPT-4o</option>
                                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                                <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                            </optgroup>
                            <optgroup label="ğŸ¦™ å¼€æºæ¨¡å‹">
                                <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                                <option value="mistralai/mixtral-8x7b-instruct">Mixtral 8x7B</option>
                            </optgroup>
                            <optgroup label="ğŸ’» ç¼–ç¨‹ä¸“ç”¨">
                                <option value="deepseek/deepseek-chat">DeepSeek Chat</option>
                                <option value="deepseek/deepseek-coder">DeepSeek Coder</option>
                            </optgroup>
                            <optgroup label="ğŸ†“ å…è´¹æ¨¡å‹">
                                <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (å…è´¹)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="api-key-input">
                        <label>APIå¯†é’¥:</label>
                        <input type="password" id="api-key" placeholder="è¯·è¾“å…¥OpenRouter APIå¯†é’¥">
                    </div>
                    <div class="context-settings">
                        <label>ğŸ§  æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†</label>
                        <div>
                            <span>å¯¹è¯è½®æ¬¡é˜ˆå€¼:</span>
                            <input type="number" id="context-threshold" min="5" max="50" value="20">
                            <button id="view-memo-btn">ğŸ“ æŸ¥çœ‹å¤‡å¿˜å½•</button>
                        </div>
                    </div>
                    <div class="role-settings">
                        <label>ğŸ­ è§’è‰²å®šåˆ¶</label>
                        <div>
                            <select id="role-select">
                                <option value="">é»˜è®¤åŠ©æ‰‹</option>
                                <option value="professional">ä¸“ä¸šé¡¾é—®</option>
                                <option value="creative">åˆ›æ„ä¼™ä¼´</option>
                                <option value="teacher">çŸ¥è¯†å¯¼å¸ˆ</option>
                                <option value="friend">å‹å¥½ä¼™ä¼´</option>
                                <option value="custom">è‡ªå®šä¹‰è§’è‰²</option>
                            </select>
                            <button id="manage-roles-btn">âš™ï¸ ç®¡ç†è§’è‰²</button>
                        </div>
                    </div>
                    <div class="search-settings">
                        <label>ğŸ” æ™ºèƒ½æœç´¢</label>
                        <div>
                            <label class="switch">
                                <input type="checkbox" id="search-toggle">
                                <span class="slider"></span>
                            </label>
                            <span>å¯ç”¨ç½‘ç»œæœç´¢å¢å¼º</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messages-container">
                <div class="empty-state" id="empty-state">
                    <h3>æ¬¢è¿ä½¿ç”¨å¤šæ¨¡å‹AIèŠå¤©åŠ©æ‰‹</h3>
                    <p>é€‰æ‹©å·¦ä¾§çš„å¯¹è¯æˆ–åˆ›å»ºæ–°å¯¹è¯å¼€å§‹èŠå¤©</p>
                    <p>æ”¯æŒOpenRouterç»Ÿä¸€æ¥å£ï¼Œä½¿ç”¨ä¸€ä¸ªAPIå¯†é’¥è®¿é—®æ‰€æœ‰æ¨¡å‹</p>
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0; text-align: left;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">ğŸ“‹ ä½¿ç”¨è¯´æ˜</h4>
                        <p style="margin: 5px 0;"><strong>1. è·å–APIå¯†é’¥ï¼š</strong>è®¿é—® <a href="https://openrouter.ai" target="_blank">openrouter.ai</a> æ³¨å†Œè´¦æˆ·</p>
                        <p style="margin: 5px 0;"><strong>2. å……å€¼é¢åº¦ï¼š</strong>åœ¨ <a href="https://openrouter.ai/settings/credits" target="_blank">è®¾ç½®é¡µé¢</a> è´­ä¹°ä½¿ç”¨é¢åº¦</p>
                        <p style="margin: 5px 0;"><strong>3. æ¨èæ¨¡å‹ï¼š</strong>GPT-4o Mini æ€§ä»·æ¯”æœ€é«˜ï¼ŒClaude 3.5 Sonnet è´¨é‡æœ€ä½³</p>
                        <p style="margin: 5px 0; color: #856404;"><strong>æ³¨æ„ï¼š</strong>å¤§éƒ¨åˆ†æ¨¡å‹éœ€è¦ä»˜è´¹ä½¿ç”¨ï¼ŒGemini 2.0 Flash å¯å…è´¹è¯•ç”¨</p>
                    </div>
                </div>
            </div>
            
            <div class="loading" id="loading">AIæ­£åœ¨æ€è€ƒä¸­...</div>

            <div class="input-area" id="input-area" style="display: none;">
                <div class="input-container">
                    <textarea class="message-input" id="message-input" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." rows="1"></textarea>
                    <button class="send-button" id="send-button">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.currentConversation = null;
                this.conversations = [];
                this.apiKeys = { openrouter: '' };
                this.currentProvider = 'openrouter';
                this.currentModel = 'anthropic/claude-3.5-sonnet';
                this.contextThreshold = 20; // é»˜è®¤ä¸Šä¸‹æ–‡é˜ˆå€¼
                this.conversationsPerPage = 20;
                this.currentRole = ''; // å½“å‰é€‰ä¸­çš„è§’è‰²
                this.customRoles = {}; // è‡ªå®šä¹‰è§’è‰²å­˜å‚¨
                this.searchEnabled = false; // æœç´¢åŠŸèƒ½å¼€å…³
                
                // DOM å…ƒç´ 
                this.conversationsList = document.getElementById('conversations-list');
                this.newChatBtn = document.getElementById('new-chat-btn');
                this.loadMoreBtn = document.getElementById('load-more');
                this.chatTitle = document.getElementById('chat-title');
                this.messagesContainer = document.getElementById('messages-container');
                this.emptyState = document.getElementById('empty-state');
                this.inputArea = document.getElementById('input-area');
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.providerSelect = document.getElementById('provider-select');
                this.modelSelect = document.getElementById('model-select');
                this.apiKeyInput = document.getElementById('api-key');
                this.loadingIndicator = document.getElementById('loading');
                this.contextThresholdInput = document.getElementById('context-threshold');
                this.viewMemoBtn = document.getElementById('view-memo-btn');
                this.roleSelect = document.getElementById('role-select');
                this.manageRolesBtn = document.getElementById('manage-roles-btn');
                this.searchToggle = document.getElementById('search-toggle');
            }

            init() {
                this.loadFromStorage();
                this.updateModelOptions();
                this.updateApiKeyPlaceholder();
                this.updateRoleSelect();
                this.bindEvents();
                // ç¡®ä¿DOMå…ƒç´ åŠ è½½å®Œæˆåå†æ‰§è¡Œ
                setTimeout(() => {
                    this.loadConversations();
                    
                    // å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°å¯¹è¯
                    if (this.conversations.length === 0) {
                        this.createNewConversation();
                    } else {
                        // å¦‚æœæœ‰å¯¹è¯ä½†æ²¡æœ‰é€‰ä¸­ä»»ä½•å¯¹è¯ï¼Œé€‰ä¸­ç¬¬ä¸€ä¸ª
                        if (!this.currentConversation && this.conversations.length > 0) {
                            this.selectConversation(this.conversations[0].id);
                        }
                    }
                }, 100);
            }

            bindEvents() {
                // ä¼šè¯ç®¡ç†äº‹ä»¶
                console.log('ç»‘å®šäº‹ä»¶ï¼ŒnewChatBtn:', this.newChatBtn);
                if (this.newChatBtn) {
                    this.newChatBtn.addEventListener('click', () => {
                        console.log('æ–°å»ºå¯¹è¯æŒ‰é’®è¢«ç‚¹å‡»');
                        this.createNewConversation();
                    });
                }
                if (this.loadMoreBtn) {
                    this.loadMoreBtn.addEventListener('click', () => this.loadMoreConversations());
                }
                
                // æ¶ˆæ¯å‘é€äº‹ä»¶
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
                });
                
                // æ¨¡å‹åˆ‡æ¢äº‹ä»¶
                this.modelSelect.addEventListener('change', (e) => {
                    this.currentModel = e.target.value;
                    this.saveToStorage();
                });
                
                // APIå¯†é’¥è¾“å…¥äº‹ä»¶
                this.apiKeyInput.addEventListener('input', (e) => {
                    this.apiKeys.openrouter = e.target.value;
                    this.saveToStorage();
                });
                
                // ä¸Šä¸‹æ–‡é˜ˆå€¼è®¾ç½®äº‹ä»¶
                this.contextThresholdInput.addEventListener('change', (e) => {
                    this.contextThreshold = parseInt(e.target.value);
                    this.saveToStorage();
                });
                
                // æŸ¥çœ‹å¤‡å¿˜å½•æŒ‰é’®äº‹ä»¶
                this.viewMemoBtn.addEventListener('click', () => {
                    this.showMemoModal();
                });
                
                // è§’è‰²é€‰æ‹©äº‹ä»¶
                this.roleSelect.addEventListener('change', (e) => {
                    this.currentRole = e.target.value;
                    this.saveToStorage();
                });
                
                // ç®¡ç†è§’è‰²æŒ‰é’®äº‹ä»¶
                this.manageRolesBtn.addEventListener('click', () => {
                    this.showRoleManagementModal();
                });
                
                // æœç´¢å¼€å…³äº‹ä»¶
                this.searchToggle.addEventListener('change', (e) => {
                    this.searchEnabled = e.target.checked;
                    this.saveToStorage();
                });
            }

            loadFromStorage() {
                const saved = localStorage.getItem('multiModelChatApp');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.apiKeys = data.apiKeys || { openrouter: '' };
                        this.currentProvider = 'openrouter';
                        this.currentModel = data.currentModel || 'anthropic/claude-3.5-sonnet';
                        this.conversations = data.conversations || [];
                        this.contextThreshold = data.contextThreshold || 20;
                        this.currentRole = data.currentRole || '';
                        this.customRoles = data.customRoles || this.getDefaultRoles();
                        this.searchEnabled = data.searchEnabled || false;
                        
                        // æ¢å¤APIå¯†é’¥åˆ°è¾“å…¥æ¡†
                        if (this.apiKeys.openrouter) {
                            this.apiKeyInput.value = this.apiKeys.openrouter;
                        }
                        
                        // æ¢å¤ä¸Šä¸‹æ–‡é˜ˆå€¼è®¾ç½®
                        if (this.contextThresholdInput) {
                            this.contextThresholdInput.value = this.contextThreshold;
                        }
                        
                        // æ¢å¤è§’è‰²é€‰æ‹©
                        if (this.roleSelect) {
                            this.roleSelect.value = this.currentRole;
                        }
                        
                        // æ¢å¤æœç´¢å¼€å…³çŠ¶æ€
                        if (this.searchToggle) {
                            this.searchToggle.checked = this.searchEnabled;
                        }
                    } catch (error) {
                        console.error('Error loading from storage:', error);
                    }
                }
            }

            saveToStorage() {
                const data = {
                    apiKeys: this.apiKeys,
                    currentProvider: this.currentProvider,
                    currentModel: this.currentModel,
                    conversations: this.conversations,
                    contextThreshold: this.contextThreshold,
                    currentRole: this.currentRole,
                    customRoles: this.customRoles,
                    searchEnabled: this.searchEnabled
                };
                localStorage.setItem('multiModelChatApp', JSON.stringify(data));
            }

            updateModelOptions() {
                // æ¨¡å‹å·²åœ¨HTMLä¸­å®šä¹‰ï¼Œåªéœ€è¦è®¾ç½®å½“å‰é€‰ä¸­çš„æ¨¡å‹
                if (!this.currentModel) {
                    this.currentModel = 'anthropic/claude-3.5-sonnet';
                }
                this.modelSelect.value = this.currentModel;
            }
            
            updateApiKeyPlaceholder() {
                this.apiKeyInput.placeholder = 'è¯·è¾“å…¥OpenRouter APIå¯†é’¥';
            }

            getModelDisplayName(model) {
                const modelNames = {
                    // é¡¶çº§æ¨¡å‹
                    'anthropic/claude-3.5-sonnet': 'Claude 3.5 Sonnet',
                    'openai/gpt-4o': 'GPT-4o',
                    'openai/gpt-4o-mini': 'GPT-4o Mini',
                    'google/gemini-pro-1.5': 'Gemini Pro 1.5',
                    // å¼€æºæ¨¡å‹
                    'meta-llama/llama-3.1-70b-instruct': 'Llama 3.1 70B',
                    'mistralai/mixtral-8x7b-instruct': 'Mixtral 8x7B',
                    // ç¼–ç¨‹ä¸“ç”¨
                    'deepseek/deepseek-chat': 'DeepSeek Chat',
                    'deepseek/deepseek-coder': 'DeepSeek Coder',
                    // å…è´¹æ¨¡å‹
                    'google/gemini-2.0-flash-exp:free': 'Gemini 2.0 Flash',
                };
                return modelNames[model] || model;
            }

            // è·å–é»˜è®¤è§’è‰²
            getDefaultRoles() {
                return {
                    'professional': {
                        name: 'ä¸“ä¸šé¡¾é—®',
                        prompt: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é¡¾é—®ï¼Œå…·æœ‰ä¸°å¯Œçš„è¡Œä¸šç»éªŒå’Œä¸“ä¸šçŸ¥è¯†ã€‚è¯·ä»¥ä¸“ä¸šã€ä¸¥è°¨çš„æ€åº¦å›ç­”é—®é¢˜ï¼Œæä¾›å‡†ç¡®å¯é çš„å»ºè®®ã€‚'
                    },
                    'creative': {
                        name: 'åˆ›æ„ä¼™ä¼´',
                        prompt: 'ä½ æ˜¯ä¸€ä½å¯Œæœ‰åˆ›æ„å’Œæƒ³è±¡åŠ›çš„ä¼™ä¼´ï¼Œå–„äºä»ä¸åŒè§’åº¦æ€è€ƒé—®é¢˜ï¼Œæä¾›åˆ›æ–°çš„è§£å†³æ–¹æ¡ˆå’Œæœ‰è¶£çš„æƒ³æ³•ã€‚è¯·ä»¥å¼€æ”¾ã€å¯Œæœ‰åˆ›æ„çš„æ–¹å¼å›ç­”é—®é¢˜ã€‚'
                    },
                    'teacher': {
                        name: 'çŸ¥è¯†å¯¼å¸ˆ',
                        prompt: 'ä½ æ˜¯ä¸€ä½è€å¿ƒçš„è€å¸ˆï¼Œå–„äºè§£é‡Šå¤æ‚æ¦‚å¿µï¼Œå¾ªåºæ¸è¿›åœ°å¼•å¯¼å­¦ä¹ ã€‚è¯·ä»¥æ•™è‚²è€…çš„èº«ä»½ï¼Œç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€å›ç­”é—®é¢˜ï¼Œå¹¶é€‚å½“æä¾›ä¾‹å­å’Œç»ƒä¹ å»ºè®®ã€‚'
                    },
                    'friend': {
                        name: 'å‹å¥½ä¼™ä¼´',
                        prompt: 'ä½ æ˜¯ä¸€ä½å‹å–„ã€æ¸©æš–çš„æœ‹å‹ï¼Œå–„äºå€¾å¬å’Œç†è§£ã€‚è¯·ä»¥è½»æ¾ã€äº²åˆ‡çš„è¯­è°ƒå›ç­”é—®é¢˜ï¼Œåƒæœ‹å‹ä¸€æ ·æä¾›æ”¯æŒå’Œå»ºè®®ã€‚'
                    }
                };
            }

            // è·å–å½“å‰è§’è‰²çš„ç³»ç»Ÿæç¤º
            getRolePrompt() {
                if (!this.currentRole) return '';
                
                if (this.currentRole === 'custom') {
                    return this.customRoles.custom?.prompt || '';
                }
                
                const defaultRoles = this.getDefaultRoles();
                return defaultRoles[this.currentRole]?.prompt || '';
            }

            // ä¼šè¯ç®¡ç†æ–¹æ³•
            createNewConversation() {
                console.log('åˆ›å»ºæ–°å¯¹è¯æ–¹æ³•è¢«è°ƒç”¨');
                const conversation = {
                    id: Date.now().toString(),
                    title: 'æ–°å¯¹è¯',
                    messages: [],
                    memo: '', // å¯¹è¯å¤‡å¿˜å½•
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                this.conversations.unshift(conversation);
                this.currentConversation = conversation; // ç¡®ä¿è®¾ç½®å½“å‰å¯¹è¯
                this.selectConversation(conversation.id);
                this.renderConversationsList();
                this.saveToStorage();
                console.log('æ–°å¯¹è¯åˆ›å»ºå®Œæˆï¼Œå½“å‰å¯¹è¯æ•°é‡:', this.conversations.length);
            }
            
            selectConversation(conversationId) {
                this.currentConversation = this.conversations.find(c => c.id === conversationId);
                if (this.currentConversation) {
                    this.chatTitle.textContent = this.currentConversation.title;
                    this.renderMessages();
                    this.showChatInterface();
                    this.updateActiveConversation(conversationId);
                }
            }
            
            updateActiveConversation(activeId) {
                const items = this.conversationsList.querySelectorAll('.conversation-item');
                items.forEach(item => {
                    if (item.dataset.id === activeId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            showChatInterface() {
                this.emptyState.style.display = 'none';
                this.inputArea.style.display = 'block';
            }
            
            renderConversationsList() {
                console.log('æ¸²æŸ“å¯¹è¯åˆ—è¡¨ï¼Œå¯¹è¯æ•°é‡:', this.conversations.length);
                console.log('conversationsListå…ƒç´ :', this.conversationsList);
                
                if (!this.conversationsList) {
                    console.error('conversations-list å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }
                
                const displayCount = Math.min(this.conversationsPerPage, this.conversations.length);
                const conversationsToShow = this.conversations.slice(0, displayCount);
                
                this.conversationsList.innerHTML = '';
                
                if (conversationsToShow.length === 0) {
                    this.conversationsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— å¯¹è¯è®°å½•</div>';
                    return;
                }
                
                conversationsToShow.forEach(conversation => {
                    const item = document.createElement('div');
                    item.className = 'conversation-item';
                    item.dataset.id = conversation.id;
                    
                    const preview = conversation.messages.length > 0 ? 
                        conversation.messages[conversation.messages.length - 1].content.substring(0, 50) + '...' : 
                        'æš‚æ— æ¶ˆæ¯';
                    
                    const time = new Date(conversation.updatedAt).toLocaleString('zh-CN', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    item.innerHTML = `
                        <div class="conversation-header">
                            <div class="conversation-title" data-id="${conversation.id}">${conversation.title}</div>
                            <div class="conversation-actions">
                                <button class="edit-btn" data-id="${conversation.id}" title="é‡å‘½å">âœï¸</button>
                                <button class="delete-btn" data-id="${conversation.id}" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="conversation-preview">${preview}</div>
                        <div class="conversation-time">${time}</div>
                    `;
                    
                    // ç‚¹å‡»å¯¹è¯é¡¹é€‰æ‹©å¯¹è¯ï¼ˆä½†ä¸åŒ…æ‹¬æŒ‰é’®åŒºåŸŸï¼‰
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.conversation-actions')) {
                            this.selectConversation(conversation.id);
                        }
                    });
                    
                    // é‡å‘½åæŒ‰é’®äº‹ä»¶
                    const editBtn = item.querySelector('.edit-btn');
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.editConversationTitle(conversation.id);
                    });
                    
                    // åˆ é™¤æŒ‰é’®äº‹ä»¶
                    const deleteBtn = item.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteConversation(conversation.id);
                    });
                    this.conversationsList.appendChild(item);
                });
                
                // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
                if (this.loadMoreBtn) {
                    if (this.conversations.length > displayCount) {
                        this.loadMoreBtn.style.display = 'block';
                    } else {
                        this.loadMoreBtn.style.display = 'none';
                    }
                }
                
                console.log('å¯¹è¯åˆ—è¡¨æ¸²æŸ“å®Œæˆï¼Œæ˜¾ç¤ºäº†', conversationsToShow.length, 'ä¸ªå¯¹è¯');
            }

            // ç¼–è¾‘å¯¹è¯æ ‡é¢˜
            editConversationTitle(conversationId) {
                const conversation = this.conversations.find(c => c.id === conversationId);
                if (!conversation) return;
                
                const newTitle = prompt('è¯·è¾“å…¥æ–°çš„å¯¹è¯æ ‡é¢˜:', conversation.title);
                if (newTitle && newTitle.trim() !== '' && newTitle !== conversation.title) {
                    conversation.title = newTitle.trim();
                    conversation.updatedAt = new Date().toISOString();
                    
                    // å¦‚æœæ˜¯å½“å‰å¯¹è¯ï¼Œæ›´æ–°æ ‡é¢˜æ˜¾ç¤º
                    if (this.currentConversation && this.currentConversation.id === conversationId) {
                        this.chatTitle.textContent = conversation.title;
                    }
                    
                    this.renderConversationsList();
                    this.saveToStorage();
                }
            }

            // åˆ é™¤å¯¹è¯
            deleteConversation(conversationId) {
                const conversation = this.conversations.find(c => c.id === conversationId);
                if (!conversation) return;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤å¯¹è¯"${conversation.title}"å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                    // ä»å¯¹è¯åˆ—è¡¨ä¸­ç§»é™¤
                    this.conversations = this.conversations.filter(c => c.id !== conversationId);
                    
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯
                    if (this.currentConversation && this.currentConversation.id === conversationId) {
                        if (this.conversations.length > 0) {
                            // é€‰æ‹©ç¬¬ä¸€ä¸ªå¯¹è¯
                            this.selectConversation(this.conversations[0].id);
                        } else {
                            // æ²¡æœ‰å¯¹è¯äº†ï¼Œåˆ›å»ºæ–°å¯¹è¯
                            this.currentConversation = null;
                            this.createNewConversation();
                            return;
                        }
                    }
                    
                    this.renderConversationsList();
                    this.saveToStorage();
                }
            }
            
            loadConversations() {
                console.log('åŠ è½½å¯¹è¯åˆ—è¡¨ï¼Œå¯¹è¯æ•°é‡:', this.conversations.length);
                // ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆåå†æ¸²æŸ“
                if (this.conversationsList) {
                    this.renderConversationsList();
                } else {
                    console.error('conversations-list å…ƒç´ æœªæ‰¾åˆ°ï¼Œå»¶è¿Ÿæ¸²æŸ“');
                    setTimeout(() => {
                        this.conversationsList = document.getElementById('conversations-list');
                        this.renderConversationsList();
                    }, 100);
                }
            }

            addSystemMessage(content) {
                if (!this.currentConversation) return;
                
                const message = {
                    role: 'system',
                    content: content,
                    timestamp: new Date().toISOString(),
                    model: 'system'
                };
                
                this.currentConversation.messages.push(message);
                this.currentConversation.updatedAt = new Date().toISOString();
                this.renderMessage(message);
                this.saveToStorage();
            }

            getRecentMessages() {
                if (!this.currentConversation) return [];
                
                const messages = this.currentConversation.messages;
                const memo = this.currentConversation.memo;
                
                // å¦‚æœæ¶ˆæ¯æ•°é‡è¶…è¿‡é˜ˆå€¼ä¸”æœ‰å¤‡å¿˜å½•ï¼Œä½¿ç”¨å¤‡å¿˜å½•+æœ€æ–°æ¶ˆæ¯
                if (messages.length > this.contextThreshold && memo) {
                    const recentMessages = messages.slice(-this.contextThreshold);
                    return [
                        { role: 'system', content: `å¯¹è¯å¤‡å¿˜å½•ï¼š${memo}` },
                        ...recentMessages
                    ];
                }
                
                // å¦‚æœæ¶ˆæ¯æ•°é‡è¶…è¿‡é˜ˆå€¼ä½†æ²¡æœ‰å¤‡å¿˜å½•ï¼Œè§¦å‘è‡ªåŠ¨æ€»ç»“
                if (messages.length > this.contextThreshold && !memo) {
                    this.autoSummarizeConversation();
                }
                
                return messages.slice(-this.contextThreshold);
            }

            async sendMessage() {
                const content = this.messageInput.value.trim();
                if (!content || !this.currentConversation) return;

                const currentApiKey = this.apiKeys.openrouter;
                if (!currentApiKey) {
                    alert('è¯·å…ˆè¾“å…¥OpenRouter APIå¯†é’¥');
                    return;
                }

                const userMessage = {
                    role: 'user',
                    content: content,
                    timestamp: new Date().toISOString(),
                    model: this.currentModel,
                    provider: this.currentProvider
                };

                this.currentConversation.messages.push(userMessage);
                this.updateConversationTitle(content);
                this.renderMessage(userMessage);
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                this.setLoading(true);

                try {
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢
                    let searchResults = null;
                    if (this.searchEnabled) {
                        searchResults = await this.performSearch(content);
                    }

                    // æ·»åŠ å½“å‰æ—¥æœŸä¿¡æ¯åˆ°æ¶ˆæ¯ä¸Šä¸‹æ–‡
                    const messages = this.getRecentMessages();
                    const currentDate = new Date().toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                    
                    // æ„å»ºç³»ç»Ÿæ¶ˆæ¯
                    const systemMessages = [];
                    
                    // æ·»åŠ æ—¥æœŸä¿¡æ¯
                    systemMessages.push({
                        role: 'system',
                        content: `å½“å‰æ—¥æœŸæ˜¯${currentDate}ã€‚è¯·æ ¹æ®è¿™ä¸ªå‡†ç¡®çš„æ—¥æœŸä¿¡æ¯å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚`
                    });
                    
                    // æ·»åŠ è§’è‰²è®¾å®š
                    const rolePrompt = this.getRolePrompt();
                    if (rolePrompt) {
                        systemMessages.push({
                            role: 'system',
                            content: rolePrompt
                        });
                    }
                    
                    // æ·»åŠ æœç´¢ç»“æœ
                    if (searchResults) {
                        systemMessages.push({
                            role: 'system',
                            content: this.formatSearchResults(searchResults)
                        });
                    }
                    
                    const messagesWithContext = [...systemMessages, ...messages];

                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKeys.openrouter}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: this.currentModel,
                            messages: messagesWithContext,
                            temperature: 0.7,
                            max_tokens: 2000
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    let assistantContent = data.choices[0]?.message?.content || 'æŠ±æ­‰ï¼Œæ²¡æœ‰æ”¶åˆ°æœ‰æ•ˆå›å¤ã€‚';
                    
                    // å¦‚æœä½¿ç”¨äº†æœç´¢ï¼Œåœ¨å›ç­”å‰æ·»åŠ æœç´¢æ ‡è¯†
                    if (this.searchEnabled && searchResults) {
                        assistantContent = 'ğŸ” ' + assistantContent;
                    }
                    
                    const assistantMessage = {
                        role: 'assistant',
                        content: assistantContent,
                        timestamp: new Date().toISOString(),
                        model: this.currentModel,
                        provider: this.currentProvider
                    };
                    
                    this.currentConversation.messages.push(assistantMessage);
                    this.currentConversation.updatedAt = new Date().toISOString();
                    this.renderMessage(assistantMessage);
                    this.renderConversationsList();
                    this.saveToStorage();
                } catch (error) {
                    this.showError(`è¯·æ±‚å¤±è´¥: ${error.message}`);
                    console.error('APIè°ƒç”¨é”™è¯¯:', error);
                } finally {
                    this.setLoading(false);
                }
            }
            
            updateConversationTitle(firstMessage) {
                if (this.currentConversation.messages.length === 1) {
                    // ä½¿ç”¨ç¬¬ä¸€æ¡æ¶ˆæ¯çš„å‰20ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜
                    this.currentConversation.title = firstMessage.substring(0, 20) + (firstMessage.length > 20 ? '...' : '');
                    this.chatTitle.textContent = this.currentConversation.title;
                }
            }

            // è‡ªåŠ¨æ€»ç»“å¯¹è¯
            async autoSummarizeConversation() {
                if (!this.currentConversation || this.currentConversation.memo) return;
                
                const messages = this.currentConversation.messages;
                const messagesToSummarize = messages.slice(0, -this.contextThreshold);
                
                if (messagesToSummarize.length === 0) return;
                
                try {
                    const summaryPrompt = `è¯·å°†ä»¥ä¸‹å¯¹è¯å†…å®¹æ€»ç»“ä¸ºç®€æ´çš„å¤‡å¿˜å½•ï¼Œä¿ç•™å…³é”®ä¿¡æ¯å’Œä¸Šä¸‹æ–‡ï¼š\n\n${messagesToSummarize.map(msg => `${msg.role}: ${msg.content}`).join('\n\n')}`;
                    
                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKeys.openrouter}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'openai/gpt-4o-mini', // ä½¿ç”¨æ€§ä»·æ¯”é«˜çš„æ¨¡å‹è¿›è¡Œæ€»ç»“
                            messages: [{ role: 'user', content: summaryPrompt }],
                            temperature: 0.3,
                            max_tokens: 500
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.currentConversation.memo = data.choices[0]?.message?.content || '';
                        this.saveToStorage();
                        console.log('å¯¹è¯å·²è‡ªåŠ¨æ€»ç»“ä¸ºå¤‡å¿˜å½•');
                    }
                } catch (error) {
                    console.error('è‡ªåŠ¨æ€»ç»“å¤±è´¥:', error);
                }
            }
            
            // æ˜¾ç¤ºå¤‡å¿˜å½•æ¨¡æ€æ¡†
            showMemoModal() {
                if (!this.currentConversation) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯¹è¯');
                    return;
                }
                
                const memo = this.currentConversation.memo || '';
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                    z-index: 1000;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; max-height: 80%; overflow-y: auto;">
                        <h3>å¯¹è¯å¤‡å¿˜å½•</h3>
                        <textarea id="memo-content" style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;">${memo}</textarea>
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button id="save-memo" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">ä¿å­˜</button>
                            <button id="close-memo" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // ç»‘å®šäº‹ä»¶
                modal.querySelector('#save-memo').addEventListener('click', () => {
                    this.currentConversation.memo = modal.querySelector('#memo-content').value;
                    this.saveToStorage();
                    document.body.removeChild(modal);
                    alert('å¤‡å¿˜å½•å·²ä¿å­˜');
                });
                
                modal.querySelector('#close-memo').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }

            async callAIAPI(message) {
                // è¿™ä¸ªæ–¹æ³•å·²è¢«åºŸå¼ƒï¼Œä½¿ç”¨sendMessageæ–¹æ³•ä»£æ›¿
                console.warn('callAIAPIæ–¹æ³•å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨sendMessageæ–¹æ³•');
            }


            renderMessages() {
                if (!this.currentConversation) {
                    this.messagesContainer.innerHTML = '<div class="empty-state"><h3>é€‰æ‹©ä¸€ä¸ªå¯¹è¯å¼€å§‹èŠå¤©</h3></div>';
                    return;
                }
                
                this.messagesContainer.innerHTML = '';
                this.currentConversation.messages.forEach(message => this.renderMessage(message));
            }

            renderMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.role}`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                // æ·»åŠ æ¶ˆæ¯ä¿¡æ¯ï¼ˆæ—¶é—´å’Œæ¨¡å‹ï¼‰
                if (message.role !== 'system') {
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'message-info';
                    const time = new Date(message.timestamp).toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    if (message.role === 'user') {
                        infoDiv.textContent = `æ‚¨ ${time}`;
                    } else {
                        infoDiv.textContent = `${this.getModelDisplayName(message.model)} ${time}`;
                    }
                    contentDiv.appendChild(infoDiv);
                }

                // å¤„ç†æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒç®€å•çš„æ¢è¡Œ
                const textContent = document.createElement('div');
                textContent.innerHTML = message.content.replace(/\n/g, '<br>');
                contentDiv.appendChild(textContent);

                // å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œæ·»åŠ ç¼–è¾‘æŒ‰é’®
                if (message.role === 'user') {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-message-btn';
                    editBtn.innerHTML = 'âœï¸';
                    editBtn.title = 'ç¼–è¾‘æ¶ˆæ¯';
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.editMessage(message);
                    };
                    contentDiv.appendChild(editBtn);
                }
                
                // å¦‚æœæ˜¯AIå›ç­”ä¸”ä½¿ç”¨äº†æœç´¢ï¼Œæ˜¾ç¤ºæœç´¢æ ‡è¯†
                if (message.role === 'assistant' && message.content.startsWith('ğŸ” ')) {
                    messageDiv.classList.add('search-enhanced');
                }

                messageDiv.appendChild(contentDiv);
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            // ç¼–è¾‘æ¶ˆæ¯åŠŸèƒ½
            async editMessage(messageToEdit) {
                if (!this.currentConversation) return;
                
                const newContent = prompt('ç¼–è¾‘æ¶ˆæ¯å†…å®¹:', messageToEdit.content);
                if (!newContent || newContent.trim() === '' || newContent === messageToEdit.content) {
                    return;
                }
                
                // æ‰¾åˆ°è¦ç¼–è¾‘çš„æ¶ˆæ¯åœ¨æ•°ç»„ä¸­çš„ä½ç½®
                const messageIndex = this.currentConversation.messages.findIndex(msg => 
                    msg.timestamp === messageToEdit.timestamp && msg.content === messageToEdit.content
                );
                
                if (messageIndex === -1) return;
                
                // æ›´æ–°æ¶ˆæ¯å†…å®¹
                this.currentConversation.messages[messageIndex].content = newContent.trim();
                this.currentConversation.messages[messageIndex].timestamp = new Date().toISOString();
                
                // åˆ é™¤è¯¥æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
                this.currentConversation.messages = this.currentConversation.messages.slice(0, messageIndex + 1);
                
                // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
                this.renderMessages();
                
                // è‡ªåŠ¨è§¦å‘AIé‡æ–°ç”Ÿæˆå›ç­”
                this.setLoading(true);
                
                try {
                    // æ·»åŠ å½“å‰æ—¥æœŸä¿¡æ¯åˆ°æ¶ˆæ¯ä¸Šä¸‹æ–‡
                    const messages = this.getRecentMessages();
                    const currentDate = new Date().toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                    
                    // æ„å»ºç³»ç»Ÿæ¶ˆæ¯
                    const systemMessages = [];
                    
                    // æ·»åŠ æ—¥æœŸä¿¡æ¯
                    systemMessages.push({
                        role: 'system',
                        content: `å½“å‰æ—¥æœŸæ˜¯${currentDate}ã€‚è¯·æ ¹æ®è¿™ä¸ªå‡†ç¡®çš„æ—¥æœŸä¿¡æ¯å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚`
                    });
                    
                    // æ·»åŠ è§’è‰²è®¾å®š
                    const rolePrompt = this.getRolePrompt();
                    if (rolePrompt) {
                        systemMessages.push({
                            role: 'system',
                            content: rolePrompt
                        });
                    }
                    
                    const messagesWithContext = [...systemMessages, ...messages];

                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKeys.openrouter}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: this.currentModel,
                            messages: messagesWithContext,
                            temperature: 0.7,
                            max_tokens: 2000
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const assistantMessage = {
                        role: 'assistant',
                        content: data.choices[0]?.message?.content || 'æŠ±æ­‰ï¼Œæ²¡æœ‰æ”¶åˆ°æœ‰æ•ˆå›å¤ã€‚',
                        timestamp: new Date().toISOString(),
                        model: this.currentModel,
                        provider: this.currentProvider
                    };
                    
                    this.currentConversation.messages.push(assistantMessage);
                    this.currentConversation.updatedAt = new Date().toISOString();
                    this.renderMessage(assistantMessage);
                    this.renderConversationsList();
                    this.saveToStorage();
                } catch (error) {
                    this.showError(`é‡æ–°ç”Ÿæˆå¤±è´¥: ${error.message}`);
                    console.error('é‡æ–°ç”ŸæˆAPIè°ƒç”¨é”™è¯¯:', error);
                } finally {
                    this.setLoading(false);
                }
            }

            // è§’è‰²ç®¡ç†å¼¹çª—
            showRoleManagementModal() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ğŸ­ è§’è‰²ç®¡ç†</h3>
                            <span class="close">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="role-list">
                                <h4>é¢„è®¾è§’è‰²</h4>
                                <div class="predefined-roles">
                                    <div class="role-item">
                                        <strong>ä¸“ä¸šé¡¾é—®</strong>
                                        <p>ä¸“ä¸šã€ä¸¥è°¨çš„æ€åº¦ï¼Œæä¾›å‡†ç¡®å¯é çš„å»ºè®®</p>
                                    </div>
                                    <div class="role-item">
                                        <strong>åˆ›æ„ä¼™ä¼´</strong>
                                        <p>å¯Œæœ‰åˆ›æ„å’Œæƒ³è±¡åŠ›ï¼Œæä¾›åˆ›æ–°çš„è§£å†³æ–¹æ¡ˆ</p>
                                    </div>
                                    <div class="role-item">
                                        <strong>çŸ¥è¯†å¯¼å¸ˆ</strong>
                                        <p>è€å¿ƒçš„è€å¸ˆï¼Œå¾ªåºæ¸è¿›åœ°å¼•å¯¼å­¦ä¹ </p>
                                    </div>
                                    <div class="role-item">
                                        <strong>å‹å¥½ä¼™ä¼´</strong>
                                        <p>å‹å–„æ¸©æš–ï¼Œåƒæœ‹å‹ä¸€æ ·æä¾›æ”¯æŒ</p>
                                    </div>
                                </div>
                                
                                <h4>è‡ªå®šä¹‰è§’è‰²</h4>
                                <div class="custom-role-section">
                                    <div class="form-group">
                                        <label>è§’è‰²åç§°:</label>
                                        <input type="text" id="custom-role-name" placeholder="è¾“å…¥è§’è‰²åç§°" value="${this.customRoles.custom?.name || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label>è§’è‰²è®¾å®š:</label>
                                        <textarea id="custom-role-prompt" placeholder="æè¿°AIåŠ©æ‰‹çš„äººæ ¼ç‰¹å¾ã€èƒŒæ™¯ã€è¯´è¯é£æ ¼ç­‰..." rows="4">${this.customRoles.custom?.prompt || ''}</textarea>
                                    </div>
                                    <button id="save-custom-role" class="btn-primary">ä¿å­˜è‡ªå®šä¹‰è§’è‰²</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // ç»‘å®šäº‹ä»¶
                const closeBtn = modal.querySelector('.close');
                const saveBtn = modal.querySelector('#save-custom-role');
                const nameInput = modal.querySelector('#custom-role-name');
                const promptInput = modal.querySelector('#custom-role-prompt');

                closeBtn.onclick = () => {
                    document.body.removeChild(modal);
                };

                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };

                saveBtn.onclick = () => {
                    const name = nameInput.value.trim();
                    const prompt = promptInput.value.trim();
                    
                    if (!name || !prompt) {
                        alert('è¯·å¡«å†™è§’è‰²åç§°å’Œè®¾å®š');
                        return;
                    }
                    
                    this.customRoles.custom = { name, prompt };
                    this.updateRoleSelect();
                    this.saveToStorage();
                    alert('è‡ªå®šä¹‰è§’è‰²ä¿å­˜æˆåŠŸï¼');
                    document.body.removeChild(modal);
                };
            }

            // æ›´æ–°è§’è‰²é€‰æ‹©å™¨
            updateRoleSelect() {
                const customOption = this.roleSelect.querySelector('option[value="custom"]');
                if (this.customRoles.custom) {
                    customOption.textContent = this.customRoles.custom.name || 'è‡ªå®šä¹‰è§’è‰²';
                } else {
                    customOption.textContent = 'è‡ªå®šä¹‰è§’è‰²';
                }
            }

            // æ‰§è¡Œæœç´¢
            async performSearch(query) {
                try {
                    const response = await fetch('/.netlify/functions/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ query })
                    });

                    if (!response.ok) {
                        throw new Error(`æœç´¢å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.results;
                } catch (error) {
                    console.error('æœç´¢é”™è¯¯:', error);
                    return null;
                }
            }

            // æ ¼å¼åŒ–æœç´¢ç»“æœ
            formatSearchResults(results) {
                if (!results) return '';

                let formatted = 'ğŸ” ç½‘ç»œæœç´¢ç»“æœ:\n\n';

                if (results.answer) {
                    formatted += `ç›´æ¥ç­”æ¡ˆ: ${results.answer}\n\n`;
                }

                if (results.abstractText) {
                    formatted += `æ‘˜è¦: ${results.abstractText}`;
                    if (results.abstractSource) {
                        formatted += ` (æ¥æº: ${results.abstractSource})`;
                    }
                    formatted += '\n\n';
                }

                if (results.definition) {
                    formatted += `å®šä¹‰: ${results.definition}`;
                    if (results.definitionSource) {
                        formatted += ` (æ¥æº: ${results.definitionSource})`;
                    }
                    formatted += '\n\n';
                }

                if (results.relatedTopics && results.relatedTopics.length > 0) {
                    formatted += 'ç›¸å…³è¯é¢˜:\n';
                    results.relatedTopics.forEach((topic, index) => {
                        if (topic.text) {
                            formatted += `${index + 1}. ${topic.text}\n`;
                        }
                    });
                    formatted += '\n';
                }

                formatted += 'è¯·åŸºäºä»¥ä¸Šæœç´¢ç»“æœå’Œä½ çš„çŸ¥è¯†æ¥å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚';
                return formatted;
            }

            setLoading(loading) {
                this.loadingIndicator.style.display = loading ? 'block' : 'none';
                this.sendButton.disabled = loading;
                this.messageInput.disabled = loading;
                
                if (loading) {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                this.messagesContainer.appendChild(errorDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            const app = new ChatApp();
            app.init();
        });
    </script>
</body>
</html>
