<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多模型AI聊天助手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* 左侧会话列表 */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: #f8f9fa;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-header h1 {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px;
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #f5f5f5;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 15px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 5px 8px;
            background: white;
        }

        .conversation-item:hover {
            background: #f8f9fa;
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .conversation-item.active {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conversation-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }

        .conversation-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .conversation-actions button:hover {
            background: rgba(0,0,0,0.1);
        }

        .edit-btn:hover {
            background: rgba(0, 123, 255, 0.1) !important;
        }

        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.1) !important;
        }

        .message-edit-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message.user {
            position: relative;
        }

        .message.user:hover .message-edit-btn {
            opacity: 1;
        }

        .message-edit-btn:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        .conversation-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-preview {
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .load-more {
            padding: 10px;
            text-align: center;
            color: #666;
            cursor: pointer;
            font-size: 14px;
        }

        .load-more:hover {
            background: #f8f9fa;
        }

        /* 右侧聊天区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .model-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .provider-selector, .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .provider-selector select, .model-selector select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            width: 200px;
        }

        .api-key-input {
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .api-key-input label, .context-settings label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
        }

        .api-key-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .api-key-input input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .context-settings > div {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .context-settings input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }

        .context-settings button {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .context-settings button:hover {
            background: #0056b3;
        }

        .role-settings {
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .role-settings > div {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .role-settings select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 120px;
        }

        .role-settings button {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .role-settings button:hover {
            background: #218838;
        }

        .role-item {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .role-item strong {
            color: #495057;
            display: block;
            margin-bottom: 5px;
        }

        .role-item p {
            color: #6c757d;
            font-size: 13px;
            margin: 0;
        }

        .custom-role-section {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .search-enhanced {
            border-left: 3px solid #2196F3 !important;
        }

        .search-enhanced .message-content {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%) !important;
        }

        .search-settings {
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .search-settings > div {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .search-indicator {
            display: inline-block;
            color: #2196F3;
            font-size: 12px;
            margin-left: 5px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #333;
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message.system .message-content {
            background: #f5f5f5;
            color: #666;
            font-style: italic;
            text-align: center;
            max-width: 100%;
        }

        .message-info {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #666;
        }

        .send-button {
            padding: 10px 20px;
            background: #333;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s;
        }

        .send-button:hover {
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 20px;
            border: 1px solid #ffcdd2;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .model-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-end;
            }
            
            .api-key-input input {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 左侧会话列表 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>AI聊天助手</h1>
                <button class="new-chat-btn" id="new-chat-btn">+ 新建对话</button>
            </div>
            <div class="conversations-list" id="conversations-list">
                <!-- 会话列表将在这里动态生成 -->
            </div>
            <div class="load-more" id="load-more" style="display: none;">加载更多会话...</div>
        </div>

        <!-- 右侧聊天区域 -->
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title" id="chat-title">选择或创建一个对话</div>
                <div class="model-controls">
                    <div class="provider-selector">
                        <label>提供商:</label>
                        <select id="provider-select">
                            <option value="openrouter">OpenRouter (统一接口)</option>
                        </select>
                    </div>
                    <div class="model-selector">
                        <label>模型:</label>
                        <select id="model-select">
                            <optgroup label="🤖 顶级模型">
                                <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                                <option value="openai/gpt-4o">GPT-4o</option>
                                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                                <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                            </optgroup>
                            <optgroup label="🦙 开源模型">
                                <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                                <option value="mistralai/mixtral-8x7b-instruct">Mixtral 8x7B</option>
                            </optgroup>
                            <optgroup label="💻 编程专用">
                                <option value="deepseek/deepseek-chat">DeepSeek Chat</option>
                                <option value="deepseek/deepseek-coder">DeepSeek Coder</option>
                            </optgroup>
                            <optgroup label="🆓 免费模型">
                                <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (免费)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="api-key-input">
                        <label>API密钥:</label>
                        <input type="password" id="api-key" placeholder="请输入OpenRouter API密钥">
                    </div>
                    <div class="context-settings">
                        <label>🧠 智能上下文管理</label>
                        <div>
                            <span>对话轮次阈值:</span>
                            <input type="number" id="context-threshold" min="5" max="50" value="20">
                            <button id="view-memo-btn">📝 查看备忘录</button>
                        </div>
                    </div>
                    <div class="role-settings">
                        <label>🎭 角色定制</label>
                        <div>
                            <select id="role-select">
                                <option value="">默认助手</option>
                                <option value="professional">专业顾问</option>
                                <option value="creative">创意伙伴</option>
                                <option value="teacher">知识导师</option>
                                <option value="friend">友好伙伴</option>
                                <option value="custom">自定义角色</option>
                            </select>
                            <button id="manage-roles-btn">⚙️ 管理角色</button>
                        </div>
                    </div>
                    <div class="search-settings">
                        <label>🔍 智能搜索</label>
                        <div>
                            <label class="switch">
                                <input type="checkbox" id="search-toggle">
                                <span class="slider"></span>
                            </label>
                            <span>启用网络搜索增强</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messages-container">
                <div class="empty-state" id="empty-state">
                    <h3>欢迎使用多模型AI聊天助手</h3>
                    <p>选择左侧的对话或创建新对话开始聊天</p>
                    <p>支持OpenRouter统一接口，使用一个API密钥访问所有模型</p>
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0; text-align: left;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">📋 使用说明</h4>
                        <p style="margin: 5px 0;"><strong>1. 获取API密钥：</strong>访问 <a href="https://openrouter.ai" target="_blank">openrouter.ai</a> 注册账户</p>
                        <p style="margin: 5px 0;"><strong>2. 充值额度：</strong>在 <a href="https://openrouter.ai/settings/credits" target="_blank">设置页面</a> 购买使用额度</p>
                        <p style="margin: 5px 0;"><strong>3. 推荐模型：</strong>GPT-4o Mini 性价比最高，Claude 3.5 Sonnet 质量最佳</p>
                        <p style="margin: 5px 0; color: #856404;"><strong>注意：</strong>大部分模型需要付费使用，Gemini 2.0 Flash 可免费试用</p>
                    </div>
                </div>
            </div>
            
            <div class="loading" id="loading">AI正在思考中...</div>

            <div class="input-area" id="input-area" style="display: none;">
                <div class="input-container">
                    <textarea class="message-input" id="message-input" placeholder="输入您的消息..." rows="1"></textarea>
                    <button class="send-button" id="send-button">发送</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.currentConversation = null;
                this.conversations = [];
                this.apiKeys = { openrouter: '' };
                this.currentProvider = 'openrouter';
                this.currentModel = 'anthropic/claude-3.5-sonnet';
                this.contextThreshold = 20; // 默认上下文阈值
                this.conversationsPerPage = 20;
                this.currentRole = ''; // 当前选中的角色
                this.customRoles = {}; // 自定义角色存储
                this.searchEnabled = false; // 搜索功能开关
                
                // DOM 元素
                this.conversationsList = document.getElementById('conversations-list');
                this.newChatBtn = document.getElementById('new-chat-btn');
                this.loadMoreBtn = document.getElementById('load-more');
                this.chatTitle = document.getElementById('chat-title');
                this.messagesContainer = document.getElementById('messages-container');
                this.emptyState = document.getElementById('empty-state');
                this.inputArea = document.getElementById('input-area');
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.providerSelect = document.getElementById('provider-select');
                this.modelSelect = document.getElementById('model-select');
                this.apiKeyInput = document.getElementById('api-key');
                this.loadingIndicator = document.getElementById('loading');
                this.contextThresholdInput = document.getElementById('context-threshold');
                this.viewMemoBtn = document.getElementById('view-memo-btn');
                this.roleSelect = document.getElementById('role-select');
                this.manageRolesBtn = document.getElementById('manage-roles-btn');
                this.searchToggle = document.getElementById('search-toggle');
            }

            init() {
                this.loadFromStorage();
                this.updateModelOptions();
                this.updateApiKeyPlaceholder();
                this.updateRoleSelect();
                this.bindEvents();
                // 确保DOM元素加载完成后再执行
                setTimeout(() => {
                    this.loadConversations();
                    
                    // 如果没有对话，创建一个新对话
                    if (this.conversations.length === 0) {
                        this.createNewConversation();
                    } else {
                        // 如果有对话但没有选中任何对话，选中第一个
                        if (!this.currentConversation && this.conversations.length > 0) {
                            this.selectConversation(this.conversations[0].id);
                        }
                    }
                }, 100);
            }

            bindEvents() {
                // 会话管理事件
                console.log('绑定事件，newChatBtn:', this.newChatBtn);
                if (this.newChatBtn) {
                    this.newChatBtn.addEventListener('click', () => {
                        console.log('新建对话按钮被点击');
                        this.createNewConversation();
                    });
                }
                if (this.loadMoreBtn) {
                    this.loadMoreBtn.addEventListener('click', () => this.loadMoreConversations());
                }
                
                // 消息发送事件
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // 自动调整输入框高度
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
                });
                
                // 模型切换事件
                this.modelSelect.addEventListener('change', (e) => {
                    this.currentModel = e.target.value;
                    this.saveToStorage();
                });
                
                // API密钥输入事件
                this.apiKeyInput.addEventListener('input', (e) => {
                    this.apiKeys.openrouter = e.target.value;
                    this.saveToStorage();
                });
                
                // 上下文阈值设置事件
                this.contextThresholdInput.addEventListener('change', (e) => {
                    this.contextThreshold = parseInt(e.target.value);
                    this.saveToStorage();
                });
                
                // 查看备忘录按钮事件
                this.viewMemoBtn.addEventListener('click', () => {
                    this.showMemoModal();
                });
                
                // 角色选择事件
                this.roleSelect.addEventListener('change', (e) => {
                    this.currentRole = e.target.value;
                    this.saveToStorage();
                });
                
                // 管理角色按钮事件
                this.manageRolesBtn.addEventListener('click', () => {
                    this.showRoleManagementModal();
                });
                
                // 搜索开关事件
                this.searchToggle.addEventListener('change', (e) => {
                    this.searchEnabled = e.target.checked;
                    this.saveToStorage();
                });
            }

            loadFromStorage() {
                const saved = localStorage.getItem('multiModelChatApp');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.apiKeys = data.apiKeys || { openrouter: '' };
                        this.currentProvider = 'openrouter';
                        this.currentModel = data.currentModel || 'anthropic/claude-3.5-sonnet';
                        this.conversations = data.conversations || [];
                        this.contextThreshold = data.contextThreshold || 20;
                        this.currentRole = data.currentRole || '';
                        this.customRoles = data.customRoles || this.getDefaultRoles();
                        this.searchEnabled = data.searchEnabled || false;
                        
                        // 恢复API密钥到输入框
                        if (this.apiKeys.openrouter) {
                            this.apiKeyInput.value = this.apiKeys.openrouter;
                        }
                        
                        // 恢复上下文阈值设置
                        if (this.contextThresholdInput) {
                            this.contextThresholdInput.value = this.contextThreshold;
                        }
                        
                        // 恢复角色选择
                        if (this.roleSelect) {
                            this.roleSelect.value = this.currentRole;
                        }
                        
                        // 恢复搜索开关状态
                        if (this.searchToggle) {
                            this.searchToggle.checked = this.searchEnabled;
                        }
                    } catch (error) {
                        console.error('Error loading from storage:', error);
                    }
                }
            }

            saveToStorage() {
                const data = {
                    apiKeys: this.apiKeys,
                    currentProvider: this.currentProvider,
                    currentModel: this.currentModel,
                    conversations: this.conversations,
                    contextThreshold: this.contextThreshold,
                    currentRole: this.currentRole,
                    customRoles: this.customRoles,
                    searchEnabled: this.searchEnabled
                };
                localStorage.setItem('multiModelChatApp', JSON.stringify(data));
            }

            updateModelOptions() {
                // 模型已在HTML中定义，只需要设置当前选中的模型
                if (!this.currentModel) {
                    this.currentModel = 'anthropic/claude-3.5-sonnet';
                }
                this.modelSelect.value = this.currentModel;
            }
            
            updateApiKeyPlaceholder() {
                this.apiKeyInput.placeholder = '请输入OpenRouter API密钥';
            }

            getModelDisplayName(model) {
                const modelNames = {
                    // 顶级模型
                    'anthropic/claude-3.5-sonnet': 'Claude 3.5 Sonnet',
                    'openai/gpt-4o': 'GPT-4o',
                    'openai/gpt-4o-mini': 'GPT-4o Mini',
                    'google/gemini-pro-1.5': 'Gemini Pro 1.5',
                    // 开源模型
                    'meta-llama/llama-3.1-70b-instruct': 'Llama 3.1 70B',
                    'mistralai/mixtral-8x7b-instruct': 'Mixtral 8x7B',
                    // 编程专用
                    'deepseek/deepseek-chat': 'DeepSeek Chat',
                    'deepseek/deepseek-coder': 'DeepSeek Coder',
                    // 免费模型
                    'google/gemini-2.0-flash-exp:free': 'Gemini 2.0 Flash',
                };
                return modelNames[model] || model;
            }

            // 获取默认角色
            getDefaultRoles() {
                return {
                    'professional': {
                        name: '专业顾问',
                        prompt: '你是一位专业的顾问，具有丰富的行业经验和专业知识。请以专业、严谨的态度回答问题，提供准确可靠的建议。'
                    },
                    'creative': {
                        name: '创意伙伴',
                        prompt: '你是一位富有创意和想象力的伙伴，善于从不同角度思考问题，提供创新的解决方案和有趣的想法。请以开放、富有创意的方式回答问题。'
                    },
                    'teacher': {
                        name: '知识导师',
                        prompt: '你是一位耐心的老师，善于解释复杂概念，循序渐进地引导学习。请以教育者的身份，用通俗易懂的语言回答问题，并适当提供例子和练习建议。'
                    },
                    'friend': {
                        name: '友好伙伴',
                        prompt: '你是一位友善、温暖的朋友，善于倾听和理解。请以轻松、亲切的语调回答问题，像朋友一样提供支持和建议。'
                    }
                };
            }

            // 获取当前角色的系统提示
            getRolePrompt() {
                if (!this.currentRole) return '';
                
                if (this.currentRole === 'custom') {
                    return this.customRoles.custom?.prompt || '';
                }
                
                const defaultRoles = this.getDefaultRoles();
                return defaultRoles[this.currentRole]?.prompt || '';
            }

            // 会话管理方法
            createNewConversation() {
                console.log('创建新对话方法被调用');
                const conversation = {
                    id: Date.now().toString(),
                    title: '新对话',
                    messages: [],
                    memo: '', // 对话备忘录
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                this.conversations.unshift(conversation);
                this.currentConversation = conversation; // 确保设置当前对话
                this.selectConversation(conversation.id);
                this.renderConversationsList();
                this.saveToStorage();
                console.log('新对话创建完成，当前对话数量:', this.conversations.length);
            }
            
            selectConversation(conversationId) {
                this.currentConversation = this.conversations.find(c => c.id === conversationId);
                if (this.currentConversation) {
                    this.chatTitle.textContent = this.currentConversation.title;
                    this.renderMessages();
                    this.showChatInterface();
                    this.updateActiveConversation(conversationId);
                }
            }
            
            updateActiveConversation(activeId) {
                const items = this.conversationsList.querySelectorAll('.conversation-item');
                items.forEach(item => {
                    if (item.dataset.id === activeId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            showChatInterface() {
                this.emptyState.style.display = 'none';
                this.inputArea.style.display = 'block';
            }
            
            renderConversationsList() {
                console.log('渲染对话列表，对话数量:', this.conversations.length);
                console.log('conversationsList元素:', this.conversationsList);
                
                if (!this.conversationsList) {
                    console.error('conversations-list 元素未找到');
                    return;
                }
                
                const displayCount = Math.min(this.conversationsPerPage, this.conversations.length);
                const conversationsToShow = this.conversations.slice(0, displayCount);
                
                this.conversationsList.innerHTML = '';
                
                if (conversationsToShow.length === 0) {
                    this.conversationsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">暂无对话记录</div>';
                    return;
                }
                
                conversationsToShow.forEach(conversation => {
                    const item = document.createElement('div');
                    item.className = 'conversation-item';
                    item.dataset.id = conversation.id;
                    
                    const preview = conversation.messages.length > 0 ? 
                        conversation.messages[conversation.messages.length - 1].content.substring(0, 50) + '...' : 
                        '暂无消息';
                    
                    const time = new Date(conversation.updatedAt).toLocaleString('zh-CN', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    item.innerHTML = `
                        <div class="conversation-header">
                            <div class="conversation-title" data-id="${conversation.id}">${conversation.title}</div>
                            <div class="conversation-actions">
                                <button class="edit-btn" data-id="${conversation.id}" title="重命名">✏️</button>
                                <button class="delete-btn" data-id="${conversation.id}" title="删除">🗑️</button>
                            </div>
                        </div>
                        <div class="conversation-preview">${preview}</div>
                        <div class="conversation-time">${time}</div>
                    `;
                    
                    // 点击对话项选择对话（但不包括按钮区域）
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.conversation-actions')) {
                            this.selectConversation(conversation.id);
                        }
                    });
                    
                    // 重命名按钮事件
                    const editBtn = item.querySelector('.edit-btn');
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.editConversationTitle(conversation.id);
                    });
                    
                    // 删除按钮事件
                    const deleteBtn = item.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteConversation(conversation.id);
                    });
                    this.conversationsList.appendChild(item);
                });
                
                // 显示/隐藏加载更多按钮
                if (this.loadMoreBtn) {
                    if (this.conversations.length > displayCount) {
                        this.loadMoreBtn.style.display = 'block';
                    } else {
                        this.loadMoreBtn.style.display = 'none';
                    }
                }
                
                console.log('对话列表渲染完成，显示了', conversationsToShow.length, '个对话');
            }

            // 编辑对话标题
            editConversationTitle(conversationId) {
                const conversation = this.conversations.find(c => c.id === conversationId);
                if (!conversation) return;
                
                const newTitle = prompt('请输入新的对话标题:', conversation.title);
                if (newTitle && newTitle.trim() !== '' && newTitle !== conversation.title) {
                    conversation.title = newTitle.trim();
                    conversation.updatedAt = new Date().toISOString();
                    
                    // 如果是当前对话，更新标题显示
                    if (this.currentConversation && this.currentConversation.id === conversationId) {
                        this.chatTitle.textContent = conversation.title;
                    }
                    
                    this.renderConversationsList();
                    this.saveToStorage();
                }
            }

            // 删除对话
            deleteConversation(conversationId) {
                const conversation = this.conversations.find(c => c.id === conversationId);
                if (!conversation) return;
                
                if (confirm(`确定要删除对话"${conversation.title}"吗？此操作无法撤销。`)) {
                    // 从对话列表中移除
                    this.conversations = this.conversations.filter(c => c.id !== conversationId);
                    
                    // 如果删除的是当前对话
                    if (this.currentConversation && this.currentConversation.id === conversationId) {
                        if (this.conversations.length > 0) {
                            // 选择第一个对话
                            this.selectConversation(this.conversations[0].id);
                        } else {
                            // 没有对话了，创建新对话
                            this.currentConversation = null;
                            this.createNewConversation();
                            return;
                        }
                    }
                    
                    this.renderConversationsList();
                    this.saveToStorage();
                }
            }
            
            loadConversations() {
                console.log('加载对话列表，对话数量:', this.conversations.length);
                // 确保在DOM加载完成后再渲染
                if (this.conversationsList) {
                    this.renderConversationsList();
                } else {
                    console.error('conversations-list 元素未找到，延迟渲染');
                    setTimeout(() => {
                        this.conversationsList = document.getElementById('conversations-list');
                        this.renderConversationsList();
                    }, 100);
                }
            }

            addSystemMessage(content) {
                if (!this.currentConversation) return;
                
                const message = {
                    role: 'system',
                    content: content,
                    timestamp: new Date().toISOString(),
                    model: 'system'
                };
                
                this.currentConversation.messages.push(message);
                this.currentConversation.updatedAt = new Date().toISOString();
                this.renderMessage(message);
                this.saveToStorage();
            }

            getRecentMessages() {
                if (!this.currentConversation) return [];
                
                const messages = this.currentConversation.messages;
                const memo = this.currentConversation.memo;
                
                // 如果消息数量超过阈值且有备忘录，使用备忘录+最新消息
                if (messages.length > this.contextThreshold && memo) {
                    const recentMessages = messages.slice(-this.contextThreshold);
                    return [
                        { role: 'system', content: `对话备忘录：${memo}` },
                        ...recentMessages
                    ];
                }
                
                // 如果消息数量超过阈值但没有备忘录，触发自动总结
                if (messages.length > this.contextThreshold && !memo) {
                    this.autoSummarizeConversation();
                }
                
                return messages.slice(-this.contextThreshold);
            }

            async sendMessage() {
                const content = this.messageInput.value.trim();
                if (!content || !this.currentConversation) return;

                const currentApiKey = this.apiKeys.openrouter;
                if (!currentApiKey) {
                    alert('请先输入OpenRouter API密钥');
                    return;
                }

                const userMessage = {
                    role: 'user',
                    content: content,
                    timestamp: new Date().toISOString(),
                    model: this.currentModel,
                    provider: this.currentProvider
                };

                this.currentConversation.messages.push(userMessage);
                this.updateConversationTitle(content);
                this.renderMessage(userMessage);
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                this.setLoading(true);

                try {
                    // 检查是否需要搜索
                    let searchResults = null;
                    if (this.searchEnabled) {
                        searchResults = await this.performSearch(content);
                    }

                    // 添加当前日期信息到消息上下文
                    const messages = this.getRecentMessages();
                    const currentDate = new Date().toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                    
                    // 构建系统消息
                    const systemMessages = [];
                    
                    // 添加日期信息
                    systemMessages.push({
                        role: 'system',
                        content: `当前日期是${currentDate}。请根据这个准确的日期信息回答用户的问题。`
                    });
                    
                    // 添加角色设定
                    const rolePrompt = this.getRolePrompt();
                    if (rolePrompt) {
                        systemMessages.push({
                            role: 'system',
                            content: rolePrompt
                        });
                    }
                    
                    // 添加搜索结果
                    if (searchResults) {
                        systemMessages.push({
                            role: 'system',
                            content: this.formatSearchResults(searchResults)
                        });
                    }
                    
                    const messagesWithContext = [...systemMessages, ...messages];

                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKeys.openrouter}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: this.currentModel,
                            messages: messagesWithContext,
                            temperature: 0.7,
                            max_tokens: 2000
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    let assistantContent = data.choices[0]?.message?.content || '抱歉，没有收到有效回复。';
                    
                    // 如果使用了搜索，在回答前添加搜索标识
                    if (this.searchEnabled && searchResults) {
                        assistantContent = '🔍 ' + assistantContent;
                    }
                    
                    const assistantMessage = {
                        role: 'assistant',
                        content: assistantContent,
                        timestamp: new Date().toISOString(),
                        model: this.currentModel,
                        provider: this.currentProvider
                    };
                    
                    this.currentConversation.messages.push(assistantMessage);
                    this.currentConversation.updatedAt = new Date().toISOString();
                    this.renderMessage(assistantMessage);
                    this.renderConversationsList();
                    this.saveToStorage();
                } catch (error) {
                    this.showError(`请求失败: ${error.message}`);
                    console.error('API调用错误:', error);
                } finally {
                    this.setLoading(false);
                }
            }
            
            updateConversationTitle(firstMessage) {
                if (this.currentConversation.messages.length === 1) {
                    // 使用第一条消息的前20个字符作为标题
                    this.currentConversation.title = firstMessage.substring(0, 20) + (firstMessage.length > 20 ? '...' : '');
                    this.chatTitle.textContent = this.currentConversation.title;
                }
            }

            // 自动总结对话
            async autoSummarizeConversation() {
                if (!this.currentConversation || this.currentConversation.memo) return;
                
                const messages = this.currentConversation.messages;
                const messagesToSummarize = messages.slice(0, -this.contextThreshold);
                
                if (messagesToSummarize.length === 0) return;
                
                try {
                    const summaryPrompt = `请将以下对话内容总结为简洁的备忘录，保留关键信息和上下文：\n\n${messagesToSummarize.map(msg => `${msg.role}: ${msg.content}`).join('\n\n')}`;
                    
                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKeys.openrouter}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'openai/gpt-4o-mini', // 使用性价比高的模型进行总结
                            messages: [{ role: 'user', content: summaryPrompt }],
                            temperature: 0.3,
                            max_tokens: 500
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.currentConversation.memo = data.choices[0]?.message?.content || '';
                        this.saveToStorage();
                        console.log('对话已自动总结为备忘录');
                    }
                } catch (error) {
                    console.error('自动总结失败:', error);
                }
            }
            
            // 显示备忘录模态框
            showMemoModal() {
                if (!this.currentConversation) {
                    alert('请先选择一个对话');
                    return;
                }
                
                const memo = this.currentConversation.memo || '';
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                    z-index: 1000;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; max-height: 80%; overflow-y: auto;">
                        <h3>对话备忘录</h3>
                        <textarea id="memo-content" style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;">${memo}</textarea>
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button id="save-memo" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">保存</button>
                            <button id="close-memo" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">关闭</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 绑定事件
                modal.querySelector('#save-memo').addEventListener('click', () => {
                    this.currentConversation.memo = modal.querySelector('#memo-content').value;
                    this.saveToStorage();
                    document.body.removeChild(modal);
                    alert('备忘录已保存');
                });
                
                modal.querySelector('#close-memo').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }

            async callAIAPI(message) {
                // 这个方法已被废弃，使用sendMessage方法代替
                console.warn('callAIAPI方法已废弃，请使用sendMessage方法');
            }


            renderMessages() {
                if (!this.currentConversation) {
                    this.messagesContainer.innerHTML = '<div class="empty-state"><h3>选择一个对话开始聊天</h3></div>';
                    return;
                }
                
                this.messagesContainer.innerHTML = '';
                this.currentConversation.messages.forEach(message => this.renderMessage(message));
            }

            renderMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.role}`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                // 添加消息信息（时间和模型）
                if (message.role !== 'system') {
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'message-info';
                    const time = new Date(message.timestamp).toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    if (message.role === 'user') {
                        infoDiv.textContent = `您 ${time}`;
                    } else {
                        infoDiv.textContent = `${this.getModelDisplayName(message.model)} ${time}`;
                    }
                    contentDiv.appendChild(infoDiv);
                }

                // 处理消息内容，支持简单的换行
                const textContent = document.createElement('div');
                textContent.innerHTML = message.content.replace(/\n/g, '<br>');
                contentDiv.appendChild(textContent);

                // 如果是用户消息，添加编辑按钮
                if (message.role === 'user') {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-message-btn';
                    editBtn.innerHTML = '✏️';
                    editBtn.title = '编辑消息';
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.editMessage(message);
                    };
                    contentDiv.appendChild(editBtn);
                }
                
                // 如果是AI回答且使用了搜索，显示搜索标识
                if (message.role === 'assistant' && message.content.startsWith('🔍 ')) {
                    messageDiv.classList.add('search-enhanced');
                }

                messageDiv.appendChild(contentDiv);
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            // 编辑消息功能
            async editMessage(messageToEdit) {
                if (!this.currentConversation) return;
                
                const newContent = prompt('编辑消息内容:', messageToEdit.content);
                if (!newContent || newContent.trim() === '' || newContent === messageToEdit.content) {
                    return;
                }
                
                // 找到要编辑的消息在数组中的位置
                const messageIndex = this.currentConversation.messages.findIndex(msg => 
                    msg.timestamp === messageToEdit.timestamp && msg.content === messageToEdit.content
                );
                
                if (messageIndex === -1) return;
                
                // 更新消息内容
                this.currentConversation.messages[messageIndex].content = newContent.trim();
                this.currentConversation.messages[messageIndex].timestamp = new Date().toISOString();
                
                // 删除该消息之后的所有消息
                this.currentConversation.messages = this.currentConversation.messages.slice(0, messageIndex + 1);
                
                // 重新渲染消息列表
                this.renderMessages();
                
                // 自动触发AI重新生成回答
                this.setLoading(true);
                
                try {
                    // 添加当前日期信息到消息上下文
                    const messages = this.getRecentMessages();
                    const currentDate = new Date().toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                    
                    // 构建系统消息
                    const systemMessages = [];
                    
                    // 添加日期信息
                    systemMessages.push({
                        role: 'system',
                        content: `当前日期是${currentDate}。请根据这个准确的日期信息回答用户的问题。`
                    });
                    
                    // 添加角色设定
                    const rolePrompt = this.getRolePrompt();
                    if (rolePrompt) {
                        systemMessages.push({
                            role: 'system',
                            content: rolePrompt
                        });
                    }
                    
                    const messagesWithContext = [...systemMessages, ...messages];

                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKeys.openrouter}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: this.currentModel,
                            messages: messagesWithContext,
                            temperature: 0.7,
                            max_tokens: 2000
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const assistantMessage = {
                        role: 'assistant',
                        content: data.choices[0]?.message?.content || '抱歉，没有收到有效回复。',
                        timestamp: new Date().toISOString(),
                        model: this.currentModel,
                        provider: this.currentProvider
                    };
                    
                    this.currentConversation.messages.push(assistantMessage);
                    this.currentConversation.updatedAt = new Date().toISOString();
                    this.renderMessage(assistantMessage);
                    this.renderConversationsList();
                    this.saveToStorage();
                } catch (error) {
                    this.showError(`重新生成失败: ${error.message}`);
                    console.error('重新生成API调用错误:', error);
                } finally {
                    this.setLoading(false);
                }
            }

            // 角色管理弹窗
            showRoleManagementModal() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>🎭 角色管理</h3>
                            <span class="close">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="role-list">
                                <h4>预设角色</h4>
                                <div class="predefined-roles">
                                    <div class="role-item">
                                        <strong>专业顾问</strong>
                                        <p>专业、严谨的态度，提供准确可靠的建议</p>
                                    </div>
                                    <div class="role-item">
                                        <strong>创意伙伴</strong>
                                        <p>富有创意和想象力，提供创新的解决方案</p>
                                    </div>
                                    <div class="role-item">
                                        <strong>知识导师</strong>
                                        <p>耐心的老师，循序渐进地引导学习</p>
                                    </div>
                                    <div class="role-item">
                                        <strong>友好伙伴</strong>
                                        <p>友善温暖，像朋友一样提供支持</p>
                                    </div>
                                </div>
                                
                                <h4>自定义角色</h4>
                                <div class="custom-role-section">
                                    <div class="form-group">
                                        <label>角色名称:</label>
                                        <input type="text" id="custom-role-name" placeholder="输入角色名称" value="${this.customRoles.custom?.name || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label>角色设定:</label>
                                        <textarea id="custom-role-prompt" placeholder="描述AI助手的人格特征、背景、说话风格等..." rows="4">${this.customRoles.custom?.prompt || ''}</textarea>
                                    </div>
                                    <button id="save-custom-role" class="btn-primary">保存自定义角色</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // 绑定事件
                const closeBtn = modal.querySelector('.close');
                const saveBtn = modal.querySelector('#save-custom-role');
                const nameInput = modal.querySelector('#custom-role-name');
                const promptInput = modal.querySelector('#custom-role-prompt');

                closeBtn.onclick = () => {
                    document.body.removeChild(modal);
                };

                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };

                saveBtn.onclick = () => {
                    const name = nameInput.value.trim();
                    const prompt = promptInput.value.trim();
                    
                    if (!name || !prompt) {
                        alert('请填写角色名称和设定');
                        return;
                    }
                    
                    this.customRoles.custom = { name, prompt };
                    this.updateRoleSelect();
                    this.saveToStorage();
                    alert('自定义角色保存成功！');
                    document.body.removeChild(modal);
                };
            }

            // 更新角色选择器
            updateRoleSelect() {
                const customOption = this.roleSelect.querySelector('option[value="custom"]');
                if (this.customRoles.custom) {
                    customOption.textContent = this.customRoles.custom.name || '自定义角色';
                } else {
                    customOption.textContent = '自定义角色';
                }
            }

            // 执行搜索
            async performSearch(query) {
                try {
                    const response = await fetch('/.netlify/functions/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ query })
                    });

                    if (!response.ok) {
                        throw new Error(`搜索失败: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.results;
                } catch (error) {
                    console.error('搜索错误:', error);
                    return null;
                }
            }

            // 格式化搜索结果
            formatSearchResults(results) {
                if (!results) return '';

                let formatted = '🔍 网络搜索结果:\n\n';

                if (results.answer) {
                    formatted += `直接答案: ${results.answer}\n\n`;
                }

                if (results.abstractText) {
                    formatted += `摘要: ${results.abstractText}`;
                    if (results.abstractSource) {
                        formatted += ` (来源: ${results.abstractSource})`;
                    }
                    formatted += '\n\n';
                }

                if (results.definition) {
                    formatted += `定义: ${results.definition}`;
                    if (results.definitionSource) {
                        formatted += ` (来源: ${results.definitionSource})`;
                    }
                    formatted += '\n\n';
                }

                if (results.relatedTopics && results.relatedTopics.length > 0) {
                    formatted += '相关话题:\n';
                    results.relatedTopics.forEach((topic, index) => {
                        if (topic.text) {
                            formatted += `${index + 1}. ${topic.text}\n`;
                        }
                    });
                    formatted += '\n';
                }

                formatted += '请基于以上搜索结果和你的知识来回答用户的问题。';
                return formatted;
            }

            setLoading(loading) {
                this.loadingIndicator.style.display = loading ? 'block' : 'none';
                this.sendButton.disabled = loading;
                this.messageInput.disabled = loading;
                
                if (loading) {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                this.messagesContainer.appendChild(errorDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            const app = new ChatApp();
            app.init();
        });
    </script>
</body>
</html>
